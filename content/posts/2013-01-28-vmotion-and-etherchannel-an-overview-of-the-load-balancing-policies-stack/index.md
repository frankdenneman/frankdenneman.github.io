---
title: "vMotion and EtherChannel, an overview of the load-balancing policies stack"
date: 2013-01-28
categories: 
  - "vmotion"
---

After posting the article “[Choose link aggregation over Multi-NIC vMotion](http://frankdenneman.nl/2013/01/25/designing-your-vmotion-networking-choose-link-aggregation-over-multi-nic-vmotion/ "Designing your vMotion networking – Choose link aggregation over Multi-NIC vMotion?")” I received a couple of similar questions. Pierre-Louis left a comment that covers most of the questions. Let me use this as an example and clarify how vMotion traffic flows through the stack of multiple load balancing algorithms and policies:

> A question relating to Lee’s post. Is there any sense to you to use two uplinks bundled in an aggregate (LAG) with Multi-NIC vMotion to give on one hand more throughput to vMotion traffic and on the other hand dynamic protocol-driven mechanisms (either forced or LACP with stuff like Nexus1Kv or DVS 5.1)? Most of the time, when I’m working on VMware environment, there is an EtherChannel (when vSphere < v5.1) with access datacenter switches that dynamically load balance traffic based on IP Hash. If i'm using LAG, the main point to me is that load balancing is done independently from the embedded mechanism of VMware (Active/Standby for instance). Do you think that there is any issue on using LAG instead of using Active/Standby design with Multi-NIC vMotion? Do you feel that there is no interest on using LAG over Active/Standby (from VMware point of view and for hardware network point of view)?

Pierre-Louis takes a bottom-up approach when reviewing the stack of virtual and physical load-balancing policies and although he is correct when stating that network load balancing is done independently from VMware’s network stack, it does not have the impact he thinks it has. Lets look at the starting point of vMotion traffic and how that impacts both the flow of packets and utilization of links. Please read the articles “[Choose link aggregation over Multi-NIC vMotion](http://frankdenneman.nl/2013/01/25/designing-your-vmotion-networking-choose-link-aggregation-over-multi-nic-vmotion/ "Designing your vMotion networking – Choose link aggregation over Multi-NIC vMotion?")” and “[Designing your vMotion network](http://frankdenneman.nl/2012/12/18/designing-your-vmotion-network/ "Designing your vMotion network")” to review some of the requirements of Multi-NIC vMotion configurations **Scenario configuration** Lets assume you have two uplinks in your host, i.e. two physical NICs per ESX host. Each vmnic used by the VMkernel NIC (vmknic) is configured as active and both links are aggregated in a Link Aggregation Group (LAG) (EtherChannel in Cisco terms). [![01-network-configuration](images/01-network-configuration2.png)](http://frankdenneman.nl/wp-content/uploads/2013/01/01-network-configuration2.png) First thing I want to clarify that the active/standby state of a vmknic is static and is controlled by the user, not a Load-Balancing policy. When using a LAG, both vmknics need to be configured active, as the load balancing policy needs to be able to send traffic across both links. Duncan explains the [impact when using Standby NICs in an IP-Hash configuration](http://www.yellow-bricks.com/2010/08/06/standby-nics-in-an-ip-hash-configuration/ "Standby NICs in an IP-Hash configuration"). **Load balancing stack** A vMotion is initiated on host-level; therefor the first load balancer that comes in to play is vMotion itself. Then the portgroup load balancing policy will make a decision followed by the physical switch. Load balancing done by the physical switch/LAG is the last element in this stack. **Step 1:** vMotion load balancing, this is done on the application layer and it is vMotion process that selects which VMkernel NIC is used. As you are using a LAG and two NICs, only one vMotion VMkernel NIC should exist. The previous mentioned article explains why you should designate all vmnics as active in a LAG. By using one vmknic enabled for vMotion, vMotion is unable to load-balance at vmknic level and sends all the traffic to the single vmknic. **Step 2:** Next step is the load-balancing policy; IP-Hash will select one NIC after it hashes both source and destination IP. That means that this vMotion operation will use the same NIC until the vMotion operation is complete. It does not use two links, as a vMotion operation connection is setup by two VMkernel NICs and thus two IP-addresses (source IP address and destination IP). As IP-Hash determines the vmknic, traffic will be send out across the physical link. **Step 3:** is at the physical switch layer and determines which port to use to connect to a NIC of the destination host. Once the physical switch receives the packet, the load balancer of the LAG configuration comes into play. The physical switch determines which path to take to the destination host according to utilization or availability of a link. Each switch vendor has different types of load balancers, too many to describe, the article “[Understanding EtherChannel Load Balancing and Redundancy on Catalyst Switches](http://www.cisco.com/en/US/tech/tk389/tk213/technologies_tech_note09186a0080094714.shtml "Understanding Etherchanel Load Balancing and Redundancy on Catalyst Switches")” describes the different load balancing operations within the Cisco Catalyst switch family. [![02-load-balancing-by-etherchannel](images/02-load-balancing-by-etherchannel.png)](http://frankdenneman.nl/wp-content/uploads/2013/01/02-load-balancing-by-etherchannel.png) **In short:** **Step 1 Load balancing by vMotion:** has no direct control over which physical NICs are used, it load balances across available multiple vmknics. **Step 2 Load balancing by IP-HASH:** Outgoing connection is hashed based on its source and destination IP address; hash is used to select a physical NIC to use for network transmissions. **Step 3 Load balancing by LAG:** Physical switch connected to destination performs the hash to choose which physical NIC to send incoming connection to. **To LAG or not to LAG, that’s the question** By using a LAG configuration for vMotion traffic, you are limited to the available bandwidth of a single uplink per vMotion operation as only one uplink is used per vMotion operation. A Multi-NIC vMotion configuration balances vMotion traffic across both VMkernel NICs. It load balances traffic for a single vMotion operation as well as multiple concurrent vMotion operations across the links. Let me state that differently; It is able to use the bandwidth of two uplinks for both a single vMotion operation, as well as multiple vMotion operations. With Multi-NIC vMotion you will get a more equal load balance distribution than with any load-balancing policy operating at NIC level. I would always select multi-NIC vMotion over LAG. A LAG requires strict configuration on both virtual level as physical level. It’s a complex configuration on both technical and political level. Multiple departments need to be involved and throughout my years as an architect I seen many infrastructures fail due to inter-department politics. Troubleshooting a LAG configuration is not an easy task in an environment where there are communication-challenges between the server and the network department. Therefor I strongly prefer not to use LAG in a virtual infrastructure Multiple single uplinks can be used to provide more bandwidth to the vMotion process and other load-balancing policies available on the distributed switch keep track of link utilization (LBT). It’s less complex, and in most cases give you better performance.
