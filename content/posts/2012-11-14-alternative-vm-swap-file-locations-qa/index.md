---
title: "(Alternative) VM swap file locations Q&amp;A"
date: 2012-11-14
categories: 
  - "drs"
  - "memory"
  - "vmotion"
  - "vmware"
---

Lately I have received a couple of questions about Swap file placement. As I mentioned in the article “[Storage DRS and alternative swap file locations](http://frankdenneman.nl/sdrs/storage-drs-and-alternative-swap-file-locations/ )”, it is possible to configure the hosts in the DRS cluster to place the virtual machine swapfiles on an alternative datastore. Here are the questions I received and my answer: **Question 1: Will placing a swap file on a local datastore increase my vMotion time?** Yes, as the destination ESXi host cannot connect to the local datastore, the file has to be placed on a datastore that is available for the new ESXi host running the incoming VM.Therefor the destination host creates a new swap file in its swap file destination. vMotion time will increase as a new file needs to be created on the local datastore of the destination host and swapped memory pages potentially need to be copied. **Question 2: Is the swap file an empty file during creation or is it zeroed out?** When a swap file is created an empty file equal to the size of the virtual machine memory configuration. This file is empty and does not contain any zeros. Please note that if the virtual machine is configured with a reservation than the swap file will be an empty file with the size of (virtual machine memory configuration – VM memory reservation). For example, if a 4GB virtual machine is configured with a 1024MB memory reservation, the size of the swap file will be 3072MB. **Question 3: What happens with the swap file placed on a non-shared datastore during vMotion?** During vMotion, the destination host creates a new swap file in its swap file destination. If the source swap file contains swapped out pages, only those pages are copied over to the destination host. **Question 4: What happens if I have an inconsistent ESXi host configuration of local swap file locations in a DRS cluster?** When selecting the option “Datastore specified by host”, an alternative swap file location has to be configured on each host separately. If one host is not configured with an alternative location, then the swap file will be stored in the working directory of the virtual machine. When that virtual machine is moved to another host configured with an alternative swap file location, the contents of the swap file is copied over to the specified location, regardless of the fact that the destination host can connect to the swap file in the working directory. [![](images/datastore-specified-by-host.png "datastore-specified-by-host")](http://frankdenneman.nl/wp-content/uploads/2012/11/datastore-specified-by-host.png) **Question 5: What happens if my specified alternative swap file location is full and I want to power-on a virtual machine?** If the alternative datastore does not have enough space, the VMkernel tries to store the VM swap file in the working directory of the virtual machine. You need to ensure enough free space is available in the working directory otherwise the VM not allowed to be powered up. **Question 6: Should I place my swap file on a replicated datastore?** Its recommended placing the swap file on a datastore that has replication disabled. Replication of files increases vMotion time. When moving the contents of a swap file into a replicated datastore, the swap file and its contents need to replicated to the replica datastore as well. If synchronous replication is used, each block/page copied from the source datastore to the destination datastore, it needs to wait until the destination datastore receives an acknowledgement from its replication partner datastore (the replica datastore). [![](images/replicated-datastores2.png "replicated datastores")](http://frankdenneman.nl/wp-content/uploads/2012/11/replicated-datastores2.png) **Question 7: Should I place my swap file on a datastore with snapshots enabled?** To save storage space and design for the most efficient use of storage capacity, it is recommended not to place the swap files on a datastore with snapshot enabled. The VMkernel places pages in a swap file if it’s there is memory pressure, either by an overcommitted state or the virtual machine requires more memory than it’s configured memory limit. It only retrieves memory from the swap file if it requires that particular page. The VMkernel will not transfer all the pages out of the swap file if the memory pressure on the host is resolved. It keeps unused swapped out pages in the swap file, as transferring unused pages is nothing more than creating system overhead. This means that a swapped out page could stay there as long as possible until the virtual machine is powered-off. Having the possibility of snapshotting idle and unused pages on storage could reduce the pools capacity used for snapshotting useful data. **Question 8: Should I place my swap file on a datastore on a thin provisioned datastore (LUN)?** This is a tricky one and it all depends on the maturity of your management processes. As long as thin provisioned datastore is adequately monitored for utilization and free space and controls are in place that ensures sufficient free space is available to cope with bursts of memory use, than it could be a viable possibility. The reason for the hesitation is the impact a thin provisioned datastores has on the continuity of the virtual machine. Placement of swap files by VMkernel is done at the logical level. The VMkernel determines if the swap file can be placed on the datastore based on its file size. That means that it checks the free space of a datastore reported by the ESX host, not the storage array. However the datastore could exist in a heavily over-provisioned datapool. Once the swap file is created the VMkernel assumes it can store pages in the entire swap file, see question 2 for swap file calculation. As the swap file is just an empty file until the VMkernel places a page in the swap file, the swap file itself takes up a little space on the thin disk datastore. Now this can go on for a long time and nothing will happen. But what if the total reservation consumed, memory overcommit-level and workload spikes on the ESXi host layer are not correlated with the available space in the thin provisioning storage pool? Understand how much space the datastore could possibly obtain and calculate the maximum configured size of all existing swap files on the datastore to avoid an Out-of space condition. [(Alternative) VM swap file locations Q&A – part 2](http://frankdenneman.nl/drs/alternative-vm-swap-file-locations-qa-part-2/) Get notification of these blogs postings and more DRS and Storage DRS information by following me on Twitter: [@frankdenneman](http://twitter.com/frankdenneman)
