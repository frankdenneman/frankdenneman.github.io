---
title: "Home Lab Fundamentals: DNS Reverse Lookup Zones"
date: 2016-06-13
categories: 
  - "home-lab"
  - "vmware"
---

[![unless its a time sync issue-750](images/unless-its-a-time-sync-issue-750.png)](http://frankdenneman.nl/wp-content/uploads/2016/06/unless-its-a-time-sync-issue-750.png) When starting your home lab, all hints and tips are welcome. The community is full of wisdom, yet sometimes certain topics are taken for granted or are perceived as common knowledge. The [Home Lab fundamentals series](http://frankdenneman.nl/2016/06/03/home-lab-fundamentals-time-sync/) focusses on these subjects, helping you how to avoid common pitfalls that provide headaches and waste incredible amounts of time. One thing we always keep learning about vSphere is that both time and DNS needs to be correct. DNS resolution is important to many vSphere components. You can go a long way without DNS and use IP-addresses within your lab, but at one point you will experience weird behavior or installs just stop without any clear explanation.In reality vSphere is build for professional environments where it's expected that proper networking structure is in place, physical and logical. When reviewing a lot of community questions, blog posts and tweets, it appears that DNS is partially setup, i.e. only forward lookup zones are configured. And although it appears to be ''just enough DNS to get things going, many have experienced that their labs start to behave differently when no reverse lookup zones are present. Time-outs or delays are more frequent, the whole environment isn't snappy anymore. Ill-configured DNS might give you the idea that the software is crap but in reality, it's the environment that is just configured crappy. When using DNS, use the four golden rules; forward, reverse, short and full. DNS in a lab environment isn't difficult to set up and if you want to simulate a proper working vSphere environment then invest time in setting up a DNS structure. It's worth it! Besides expanding your knowledge, your systems will feel more robust and believe me, you will wait a lot less on systems to respond. **vCenter and DNS** vCenter inventory and search rely heavy on DNS. And since the introduction of vCenter Single Sign-On service (SSO) as a part of the vCenter Server management infrastructure DNS has become a crucial element. SSO is an authentication broker and security token exchange infrastructure. As described in the KB article [Upgrading to vCenter Server 5.5 best practices (2053132)](https://kb.vmware.com/kb/2053132);

> With vCenter Single Sign-On, local operating system users become far less important than the users in a directory service such as Active Directory. As a result, it is not always possible, or even desirable, to keep local operating system users as authenticated users.

This means that you are somewhat pressured into using an 'external' identity source for user authentication, even for your lab environment . One of the most popular configurations is the use of Active Directory as an identity source. Active Directory itself uses DNS as the location mechanism for domain controllers and services. If you have configured SSO to use Microsoft Active Directory for authentication, you might have seen some weird behavior when you haven't created a reverse DNS lookup zone.

**Installation of vCenter Server (Appliance) fails if the FQDN and IP addresses used are not resolvable by the DNS server specified during the deployment process.** The [vSphere 6.0 Documentation Center vSphere DNS requirements](http://pubs.vmware.com/vsphere-60/topic/com.vmware.vsphere.install.doc/GUID-1DD8E69C-4551-4C18-8698-7BFE01BEA8B7.html) state the following:

> Ensure that DNS reverse lookup returns a Fully Qualified Domain Name (FQDN) when queried with the IP address of the host machine on which vCenter Server is installed. When you install or upgrade vCenter Server, the installation or upgrade of the Web server component that supports the vSphere Web Client fails if the installer cannot look up the fully qualified domain name of the vCenter Server host machine from its IP address. Reverse lookup is implemented using PTR records.

Before deploying vCenter I recommend to deploy a virtual machine on the first host running a DNS server. The [ESXi Embedded Host Client](http://pubs.vmware.com/Release_Notes/en/vsphere/60/vmware-host-client-10-release-notes.html) allows you to deploy a virtual machine on an ESXi host without the need of having an operational vCenter first. As I use active Directory as identity source for authentication, I deploy a Windows AD server with DNS before deploying the vCenter Server Appliance (VCSA). Toms IT pro has a great article on [how to configure DNS on a Windows 2012 server](http://www.tomsitpro.com/articles/configure-dns-windows-server-2012,2-793.html), but if you want to configure a [lightweight DNS server running on Linux](http://www.virtualizationhowto.com/2015/04/lightweight-dns-server-vmware-lab/), follow the steps [Brandon Lee](https://twitter.com/vspinmaster) has documented. If you want to explore the interesting world of DNS, you can also opt to use Dynamic DNS to automatically register both the VCSA and ESXi hosts in the DNS server. Dynamic DNS registration is the process by which a DHCP client register its DNS with a name server. For more information please check out [William](https://twitter.com/lamw) article "[Does ESXi Support DDNS (Dynamic DNS)?](http://www.virtuallyghetto.com/2013/08/does-esxi-support-ddns-dynamic-dns.html)" . Although he published it in 2013. it's still a valid configuration in ESXi 6.0. **Flexibility of using DNS** Interestingly enough, having a proper DNS structure in place before deploying the virtual infrastructure provides future flexibility.  One of the more annoying time wasters is the result of using an IP address instead of an FQDN during setup of the VCSA. When you use only an IP-address instead of a Fully Qualified Domain Name (FQDN) during setup, changing the hostname or IP-address will produce this error: _IPv4 configuration for nic0 of this node cannot be edited post deployment._ Kb article 2124422 states the following:

**Attempting to change the IP address of the VMware vCenter Server Appliance 6.0 fails with the error: IPv4 configuration for nic0 of this node cannot be edited post deployment.** ([2124422](https://kb.vmware.com/kb/2124422))

> _This occurs when the VMware vCenter Server Appliance 6.0 is deployed using an IP address. During the initial configuration of the VMware vCenter Server Appliance, the system name is used as the Primary Network Identifier. If the Primary Network Identifier is an IP address, it cannot be changed after deployment_. _This is an expected behavior of the VMware vCenter Server Appliance 6.0. To change the IP address for the VMware vCenter Server Appliance 6.0 that was deployed using an IP address, not a Fully Qualified Domain Name, you must redeploy the appliance with the new IP address information._

Changing the hostname will result in the Platform Service Controller (responsible for SSO) to fail. According to Kb article:

**Changing the IP address or host name of the vCenter Server or Platform Service controller cause services to fail** ([2130599](https://kb.vmware.com/kb/2130599))

> _Changing the Primary Network Identifier (PNID) of the vCenter Server or PSC is currently not supported and will cause the vSphere services to fail to start. If the vCenter Server or PSC has been deployed with an FQDN or IP as the PNID, you will not be able to change this configuration._ _To resolve this issue, use one of these options:_
> 
> - _Revert to a snapshot or backup prior to the IP address or hostname change._
> - _Redeploy the vSphere environment._

This means that you cannot change the IP-address or the host name of the vCenter Appliance. Yet another reason to deploy a proper DNS structure before deploying your VCSA in your lab. **FQDN and vCenter permissions** Even when you have managed to install vCenter without a reverse lookup zone, the absence of DNS pointer records can obstruct proper permission configuration according to ([KB article 2127213](https://kb.vmware.com/kb/2127213))

**Unable to add Active Directory users or groups to vCenter Server Appliance or vRealize Automation permissions** 

_Attempting to browse and add users to the vCenter Server permissions (Local Permission: Hosts and Clusters > vCenter >Manage >Permissions)(Global Permissions: Administration > Global Permissions) fails with the error:_

_Cannot load the users for the selected domain_

A workaround for this issue is to ensure that all DNS servers have the Reverse Lookup Zone configured as well as Active Directory Domain Controller (AD DC) Pointer (PTR) records present. Please **note** that allowing domain authentication (assuming AD) on the ESXi host does not automatically add it to an AD managed DNS zone. You'll need to manually create the forward lookup (which will give the option for the reverse lookup creation too). **SSH session password delay** When running multiple hosts most of you will recognize the waste of time when (quickly) wanting to log into ESXi via an SSH session. Typically this happens when you start a test and you want to monitor ESXTOP output. You start your ssh session, to save time you type on the command line ssh root@esxi.homelab.com and then you have to wait more than 30 seconds to get a password prompt back. Especially funny when you are chasing a VM and DRS decided to move it to another server when you weren't paying attention. To get rid of this annoying time waster forever:

**DNS name resolution using** nslookup **takes up to 40 seconds on an ESXi host**([KB article 2070192](https://kb.vmware.com/kb/2070192))

_When you do not have a reverse lookup zone configured, you may experience a delay of several seconds when logging_ in to _hosts via SSH._

When you're management machine is not using the same DNS structure, you can apply the quick hack of adding "useDNS no" to the /etc/ssh/sshd.config file on the ESXi host to avoid the 30-second password delay. **Troubleshoot DNS** [BuildVirtual.net](http://buildvirtual.net/) published an excellent article on [how to troubleshoot ESXi Host DNS and Routing related issues](http://buildvirtual.net/troubleshoot-esxi-host-dns-and-routing-related-issues/). For more information about setting the DNS configuration from the command line, review [this section](https://pubs.vmware.com/vsphere-60/topic/com.vmware.vcli.examples.doc/cli_manage_networks.11.8.html) of the VMware vSphere 6.0 Documentation Center **vSphere components moving away from DNS** As DNS is an extra dependency, a lot of newer technologies try to avoid incorporate DNS dependencies. One of those is VMware HA. HA has been redesigned and the new FDM architecture avoided DNS dependencies. Unfortunately not all VMware  official documentation has been updated with this notion: [https://kb.vmware.com/kb/1003735](https://kb.vmware.com/kb/1003735) states that ESX 5.x also has this problem but that is not true. Simply put, VMware HA in vSphere 5.x and above does not depend on DNS for operations or configurations. Home Lab Fundamentals Series:

- [Time Sync](http://frankdenneman.nl/2016/06/03/home-lab-fundamentals-time-sync/)
- [DNS Reverse Lookup Zones](http://frankdenneman.nl/2016/06/13/home-lab-fundamentals-dns-reverse-lookup-zones/)

Up next in this series: vSwitch0 routing
